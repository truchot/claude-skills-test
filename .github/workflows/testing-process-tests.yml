name: Testing Process Skill Tests

on:
  push:
    paths:
      - '.claude/skills/testing-process/**'
      - '.github/workflows/testing-process-tests.yml'
  pull_request:
    paths:
      - '.claude/skills/testing-process/**'
      - '.github/workflows/testing-process-tests.yml'
  workflow_dispatch:

jobs:
  validate-testing-process-skill:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run validation tests
        working-directory: .claude/skills/testing-process/tests
        run: npm test

      - name: Count agents
        run: |
          echo "=== Testing Process Skill Agent Count ==="
          total=0
          for domain in strategy types quality performance security accessibility; do
            count=$(find .claude/skills/testing-process/agents/$domain -name "*.md" 2>/dev/null | wc -l)
            echo "$domain: $count agents"
            total=$((total + count))
          done
          echo "---"
          echo "Total: $total agents"

          if [ $total -ne 25 ]; then
            echo "ERROR: Expected 25 agents, found $total"
            exit 1
          fi

      - name: Validate frontmatter
        run: |
          echo "=== Validating Frontmatter ==="
          errors=0

          for file in $(find .claude/skills/testing-process/agents -name "*.md"); do
            if ! head -1 "$file" | grep -q "^---$"; then
              echo "ERROR: Missing frontmatter in $file"
              errors=$((errors + 1))
            fi
          done

          if [ $errors -gt 0 ]; then
            echo "Found $errors frontmatter errors"
            exit 1
          fi

          echo "All frontmatter valid!"

      - name: Check for empty files
        run: |
          echo "=== Checking for Empty Files ==="
          empty_files=$(find .claude/skills/testing-process -name "*.md" -empty)

          if [ -n "$empty_files" ]; then
            echo "ERROR: Found empty files:"
            echo "$empty_files"
            exit 1
          fi

          echo "No empty files found!"

      - name: Validate SKILL.md
        run: |
          echo "=== Validating SKILL.md ==="
          skill_file=".claude/skills/testing-process/SKILL.md"

          if [ ! -f "$skill_file" ]; then
            echo "ERROR: SKILL.md not found"
            exit 1
          fi

          if ! grep -q "name: testing-process" "$skill_file"; then
            echo "ERROR: Invalid skill name"
            exit 1
          fi

          if ! grep -q "version:" "$skill_file"; then
            echo "ERROR: Missing version"
            exit 1
          fi

          echo "SKILL.md is valid!"

  report-coverage:
    runs-on: ubuntu-latest
    needs: validate-testing-process-skill

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Coverage Report
        run: |
          echo "# Testing Process Skill Coverage Report" > coverage-report.md
          echo "" >> coverage-report.md
          echo "## Domains" >> coverage-report.md
          echo "" >> coverage-report.md
          echo "| Domain | Agents | Status |" >> coverage-report.md
          echo "|--------|--------|--------|" >> coverage-report.md

          for domain in strategy types quality performance security accessibility; do
            count=$(find .claude/skills/testing-process/agents/$domain -name "*.md" 2>/dev/null | wc -l)
            echo "| $domain | $count | ✅ |" >> coverage-report.md
          done

          total=$(find .claude/skills/testing-process/agents -name "*.md" | wc -l)
          echo "" >> coverage-report.md
          echo "**Total: $total agents**" >> coverage-report.md
          echo "" >> coverage-report.md
          echo "All tests passed! ✅" >> coverage-report.md

          cat coverage-report.md

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: testing-process-coverage
          path: coverage-report.md
