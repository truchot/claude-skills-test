# ═══════════════════════════════════════════════════════════════════════════════
# PLANNING GATE CHECKLIST
# ═══════════════════════════════════════════════════════════════════════════════

checklist:
  id: planning-gate
  name: "Planning Gate Checklist"
  description: "Validates that planning phase is complete before development can start"
  gate_type: blocking
  version: "1.0"

  applies_to:
    roles: ["product-manager", "tech-architect", "lead-developer"]
    phases: ["planning"]
    workflow_levels: [2, 3, 4]

  sections:
    # ─────────────────────────────────────────────────────────────────────────
    # PRD (Product Requirements Document)
    # ─────────────────────────────────────────────────────────────────────────
    - id: prd
      name: "PRD Completeness"
      description: "Product Requirements Document validation"
      items:
        - id: prd-exists
          description: "PRD document exists"
          required: true
          auto_check:
            type: file_exists
            path: ".project/01-vision/PRD.md"

        - id: problem-statement
          description: "Problem statement is clear and evidence-based"
          required: true
          auto_check:
            type: grep
            pattern: "## Problem|### Problem Statement"
            files: ".project/01-vision/PRD.md"

        - id: success-metrics
          description: "Success metrics are defined and measurable"
          required: true
          auto_check:
            type: grep
            pattern: "## Success|### Metrics|### Success Criteria"
            files: ".project/01-vision/PRD.md"

        - id: scope-defined
          description: "Scope is explicitly defined (in and out)"
          required: true
          auto_check:
            type: grep
            pattern: "## Scope|### In Scope|### Out of Scope"
            files: ".project/01-vision/PRD.md"

        - id: stakeholder-approval
          description: "Stakeholder has approved the PRD"
          required: true
          auto_check: null
          manual_prompt: "Has the PRD been approved by stakeholders?"
          evidence_required: true

    # ─────────────────────────────────────────────────────────────────────────
    # ARCHITECTURE
    # ─────────────────────────────────────────────────────────────────────────
    - id: architecture
      name: "Architecture Documentation"
      description: "System architecture validation"
      items:
        - id: architecture-exists
          description: "Architecture overview document exists"
          required: true
          auto_check:
            type: file_exists
            path: ".project/03-architecture/overview.md"

        - id: stack-defined
          description: "Technology stack is defined"
          required: true
          auto_check:
            type: file_exists
            path: ".project/03-architecture/stack.md"

        - id: components-defined
          description: "System components are defined"
          required: true
          auto_check:
            type: grep
            pattern: "## Components|### Component"
            files: ".project/03-architecture/overview.md"

        - id: security-addressed
          description: "Security considerations are documented"
          required: true
          auto_check:
            type: grep
            pattern: "## Security|### Security"
            files: ".project/03-architecture/*.md"

        - id: scalability-addressed
          description: "Scalability considerations are documented"
          required: false
          auto_check:
            type: grep
            pattern: "## Scalability|### Scalability|scalab"
            files: ".project/03-architecture/*.md"

    # ─────────────────────────────────────────────────────────────────────────
    # ADRs (Architecture Decision Records)
    # ─────────────────────────────────────────────────────────────────────────
    - id: adrs
      name: "Architecture Decisions"
      description: "Key decisions are documented"
      items:
        - id: adrs-exist
          description: "At least one ADR exists for major decisions"
          required: true
          auto_check:
            type: command
            command: "ls .project/03-architecture/decisions/ADR-*.md 2>/dev/null | wc -l"
            success_condition: "output >= 1"
          skip_conditions:
            - when: "L1 Task"
              reason: "ADRs not required for small tasks"

        - id: adr-format-valid
          description: "ADRs follow standard format"
          required: true
          auto_check:
            type: grep
            pattern: "## Context|## Decision|## Consequences"
            files: ".project/03-architecture/decisions/ADR-*.md"

    # ─────────────────────────────────────────────────────────────────────────
    # API CONTRACT (Conditional)
    # ─────────────────────────────────────────────────────────────────────────
    - id: api-contract
      name: "API Contract"
      description: "API specification (if applicable)"
      items:
        - id: api-spec-exists
          description: "API specification exists"
          required: false
          auto_check:
            type: file_exists
            path: ".project/03-architecture/api-contract.yaml"
          skip_conditions:
            - when: "No API in project"
              reason: "Project has no API"

        - id: endpoints-defined
          description: "All endpoints are defined"
          required: false
          auto_check:
            type: grep
            pattern: "paths:|/api/"
            files: ".project/03-architecture/api-contract.yaml"
          skip_conditions:
            - when: "No API in project"
              reason: "Project has no API"

    # ─────────────────────────────────────────────────────────────────────────
    # DATA MODEL (Conditional)
    # ─────────────────────────────────────────────────────────────────────────
    - id: data-model
      name: "Data Model"
      description: "Database schema (if applicable)"
      items:
        - id: data-model-exists
          description: "Data model document exists"
          required: false
          auto_check:
            type: file_exists
            path: ".project/03-architecture/data-model.md"
          skip_conditions:
            - when: "No database in project"
              reason: "Project has no database"

        - id: entities-defined
          description: "All entities are defined"
          required: false
          auto_check:
            type: grep
            pattern: "## Entities|### Entity|## Tables"
            files: ".project/03-architecture/data-model.md"
          skip_conditions:
            - when: "No database in project"
              reason: "Project has no database"

    # ─────────────────────────────────────────────────────────────────────────
    # ESTIMATION
    # ─────────────────────────────────────────────────────────────────────────
    - id: estimation
      name: "Estimation"
      description: "Effort estimation completed"
      items:
        - id: high-level-estimate
          description: "High-level estimate exists"
          required: true
          auto_check: null
          manual_prompt: "Has the project/feature been estimated?"

        - id: estimate-reviewed
          description: "Estimate reviewed with stakeholders"
          required: true
          auto_check: null
          manual_prompt: "Has the estimate been reviewed and accepted?"

    # ─────────────────────────────────────────────────────────────────────────
    # APPROVAL
    # ─────────────────────────────────────────────────────────────────────────
    - id: approval
      name: "Final Approval"
      description: "Planning phase sign-off"
      items:
        - id: pm-approval
          description: "Product Manager approves requirements"
          required: true
          auto_check: null
          manual_prompt: "Does Product Manager approve the requirements?"
          evidence_required: true

        - id: architect-approval
          description: "Tech Architect approves architecture"
          required: true
          auto_check: null
          manual_prompt: "Does Tech Architect approve the architecture?"
          evidence_required: true

        - id: lead-approval
          description: "Lead Developer approves feasibility"
          required: true
          auto_check: null
          manual_prompt: "Does Lead Developer confirm feasibility?"
          evidence_required: true

# ═══════════════════════════════════════════════════════════════════════════════
# ON PASS
# ═══════════════════════════════════════════════════════════════════════════════

on_pass:
  actions:
    - "Set state.phase.planning_approved = true"
    - "Set state.phase.planning_approved_at = now()"
    - "Freeze architecture artifacts"
    - "Create checkpoint: 'planning-complete'"
    - "Allow transition to development phase"

  freeze_artifacts:
    - ".project/03-architecture/overview.md"
    - ".project/03-architecture/stack.md"
    - ".project/03-architecture/api-contract.yaml"
    - ".project/03-architecture/data-model.md"
    - ".project/03-architecture/decisions/*.md"

# ═══════════════════════════════════════════════════════════════════════════════
# ON FAIL
# ═══════════════════════════════════════════════════════════════════════════════

on_fail:
  actions:
    - "List all failing items"
    - "Block transition to development"
    - "Request completion of missing items"

  message_template: |
    ⛔ Planning Gate Failed

    The following items must be completed before development can start:

    {failing_items}

    Please address these items and re-run the planning gate validation.
